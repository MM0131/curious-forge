<template>
  <section class="py-14">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-3xl font-extrabold mb-8">{{ t('profile.title') }}</h1>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <StatCard :value="viewCount" :label="t('profile.stats.viewed')" />
        <StatCard :value="savedCount" :label="t('profile.stats.saved')" />
        <StatCard :value="contributeCount" :label="t('profile.stats.contributed')" />
      </div>

      <h2 class="mt-10 text-xl font-semibold">{{ t('profile.savedProjects') }}</h2>

      <ClientOnly>
        <div v-if="savedBlueprints.length === 0" class="mt-6 card text-center py-12">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-slate-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
          <p class="text-slate-400 text-lg mb-2">{{ t('profile.noSaved') }}</p>
          <p class="text-slate-500 text-sm mb-4">{{ t('profile.noSavedAction') }}</p>
          <NuxtLink to="/library" class="btn-primary inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            {{ t('nav.library') }}
          </NuxtLink>
        </div>

        <div v-else class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div v-for="bp in savedBlueprints" :key="bp.id" class="relative group">
          <NuxtLink :to="`/blueprints/${bp.id}`" class="block">
            <div class="card hover:bg-white/7 transition">
              <img v-if="bp.image" :src="bp.image" :alt="bp.title" class="w-full h-44 object-cover rounded-xl mb-4" />
              <h3 class="text-lg font-semibold leading-snug">{{ bp.title }}</h3>
              <p class="mt-1 text-sm text-slate-300 line-clamp-2">{{ bp.purpose }}</p>
              
              <div class="mt-4 flex items-center gap-3 text-xs text-slate-300">
                <span class="px-2 py-1 rounded-lg bg-white/5 border border-white/10">{{ bp.time }}</span>
                <span class="px-2 py-1 rounded-lg bg-white/5 border border-white/10">{{ (bp.materials?.length || 0) }} {{ t('library.card.materials') }}</span>
                <span class="px-2 py-1 rounded-lg bg-emerald-600/15 border border-emerald-500/20 text-emerald-200">{{ bp.difficulty }}</span>
              </div>
            </div>
          </NuxtLink>
          <button
            @click.prevent="removeSaved(bp.id)"
            class="absolute top-3 right-3 z-10 px-3 py-1.5 text-xs rounded-lg bg-rose-600/80 hover:bg-rose-600 border border-rose-500/50 transition-all opacity-0 group-hover:opacity-100"
            :aria-label="t('profile.removeLabel')"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            {{ t('profile.remove') }}
          </button>
          </div>
        </div>
      </ClientOnly>
    </div>
  </section>
</template>

<script setup lang="ts">
import StatCard from '~/components/StatCard.vue'
import { useSaved } from '~/composables/useSaved'
import { useBlueprints } from '~/composables/useBlueprints'
import { onMounted } from 'vue'

const { t } = useI18n()
const { load } = useBlueprints()
const { savedIds, savedBlueprints, count: savedCount, remove } = useSaved()

// ยังไม่มีการเก็บสถิติจริงสำหรับ 2 ค่าแรก/สุดท้าย จึงใส่ 0 ไว้ก่อน
const viewCount = 0
const contributeCount = 0

function removeSaved(id: string) {
  remove(id)
}

onMounted(() => {
  // Ensure blueprints are loaded so saved list can map from DB
  load()
})
</script>
